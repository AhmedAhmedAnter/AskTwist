<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اسأل تويست</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient-start: #111827; --bg-gradient-end: #020617;
            --accent-color: #38bdf8; --user-bubble-color: #0ea5e9;
            --glass-bg: rgba(30, 41, 59, 0.5); --glass-border: rgba(255, 255, 255, 0.1);
        }
        body.theme-cosmic {
            --bg-gradient-start: #1f0033; --bg-gradient-end: #000000;
            --accent-color: #a78bfa; --user-bubble-color: #8b5cf6;
            --glass-bg: rgba(55, 22, 88, 0.5);
        }
        body.theme-forest {
            --bg-gradient-start: #064e3b; --bg-gradient-end: #052e16;
            --accent-color: #4ade80; --user-bubble-color: #22c55e;
            --glass-bg: rgba(4, 72, 55, 0.5);
        }

        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start), var(--bg-gradient-end));
            background-attachment: fixed;
            transition: background 0.5s ease;
            overflow: hidden;
        }
        
        .glass-pane { 
            background-color: var(--glass-bg); 
            -webkit-backdrop-filter: blur(20px); 
            backdrop-filter: blur(20px); 
            border: 1px solid var(--glass-border);
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }
        .chat-messages::-webkit-scrollbar, .chat-list::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track, .chat-list::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb, .chat-list::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.2); border-radius: 3px; }
        
        .pop-in { animation: pop-in 0.5s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes pop-in { 
            0% { transform: scale(0.9) translateY(20px); opacity: 0; } 
            100% { transform: scale(1) translateY(0); opacity: 1; } 
        }

        .blinking-cursor { animation: blink 1s step-end infinite; }
        @keyframes blink { from, to { opacity: 0; } 50% { opacity: 1; } }
        
        #app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        
        #sidebar {
            width: 288px; /* 72 in tailwind units */
            flex-shrink: 0;
            transition: transform 0.3s ease-in-out;
            z-index: 100;
        }

        #main-content {
            flex-grow: 1;
            transition: margin-right 0.3s ease-in-out;
        }

        /* Desktop layout */
        @media (min-width: 768px) {
            #sidebar.collapsed {
                transform: translateX(100%);
            }
            #sidebar.collapsed + #main-content {
                margin-right: -288px;
            }
        }

        /* Mobile layout */
        @media (max-width: 767px) {
            #sidebar {
                position: fixed;
                top: 0;
                right: 0;
                height: 100%;
                transform: translateX(100%);
            }
            #sidebar.open {
                transform: translateX(0);
            }
            #sidebar-overlay {
                transition: opacity 0.3s ease-in-out;
            }
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200">

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[110] p-4">
        <div class="glass-pane rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center pop-in">
            <h2 id="confirmation-title" class="text-2xl font-bold mb-4 text-white">هل أنت متأكد؟</h2>
            <p id="confirmation-message" class="text-slate-300 mb-6">لا يمكن التراجع عن هذا الإجراء.</p>
            <div class="flex gap-4">
                <button id="confirm-btn" class="flex-1 bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-lg transition-colors">تأكيد</button>
                <button id="cancel-btn" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-lg transition-colors">إلغاء</button>
            </div>
        </div>
    </div>
    
    <div id="login-overlay" class="fixed inset-0 bg-slate-900/50 backdrop-blur-md flex items-center justify-center z-[100] p-4">
        <div class="text-center p-8 glass-pane rounded-2xl shadow-2xl pop-in max-w-sm w-full">
            <div class="w-24 h-24 mx-auto rounded-full bg-gradient-to-br from-sky-500 to-fuchsia-600 flex items-center justify-center text-5xl font-bold shadow-2xl shadow-sky-500/20 mb-4">T</div>
            <h1 class="text-3xl font-bold text-white">أهلاً بك في "اسأل تويست"</h1>
            <p class="text-slate-400 mt-2 mb-6">سجّل دخولك لتبدأ المغامرة.</p>
            <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 bg-white text-slate-800 font-bold py-3 px-6 rounded-lg hover:bg-slate-200 transition-colors">
                <svg class="w-6 h-6" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
                تسجيل الدخول باستخدام جوجل
            </button>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div id="app-container" class="hidden">
        <div id="sidebar-overlay" class="hidden md:hidden fixed inset-0 bg-black/60 z-40"></div>
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-slate-900/30 backdrop-blur-xl border-l border-slate-800/50 flex flex-col p-4 h-full">
            <div class="flex-grow flex flex-col min-h-0">
                <button id="newChatBtn" class="w-full text-right bg-sky-600/80 hover:bg-sky-500 text-white rounded-lg p-3 mb-4 transition-all flex items-center gap-3 font-semibold shadow-lg shadow-sky-500/10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    محادثة جديدة
                </button>
                <div id="chat-list" class="flex-grow overflow-y-auto space-y-2 pr-2 -mr-2"></div>
                
                <div class="mt-4 border-t border-slate-700/50 pt-4">
                    <button id="open-tools-modal-btn" class="w-full text-right hover:bg-slate-700/50 rounded-lg p-3 transition-colors flex items-center gap-3 font-semibold text-slate-300 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.532 1.532 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.532 1.532 0 01-.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
                        أدوات تويست
                    </button>
                </div>
            </div>
            <div id="user-profile" class="border-t border-slate-700/50 pt-4 flex items-center gap-3"></div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex flex-col min-w-0">
            <header class="flex items-center justify-between p-4 border-b border-slate-800/50 bg-slate-900/30 backdrop-blur-xl z-10">
                 <h1 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-sky-400 to-fuchsia-500">اسأل تويست</h1>
                 <button id="sidebar-toggle-btn" class="p-2 text-slate-300 hover:text-white">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-16 6h16" /></svg>
                 </button>
            </header>
            
            <div id="chat-view" class="flex-1 flex flex-col min-h-0">
                <div id="chat-messages" class="chat-messages flex-1 overflow-y-auto p-4 sm:p-6 space-y-6"></div>
                <div class="p-4 bg-transparent">
                    <form id="chat-form" class="relative">
                        <input type="text" id="userInput" class="w-full glass-pane rounded-xl py-4 pr-4 pl-16 text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all text-base sm:text-lg" placeholder="اكتب سؤالك هنا..." autocomplete="off">
                        <button type="submit" id="submitBtn" class="absolute inset-y-0 left-0 flex items-center justify-center bg-gradient-to-br from-sky-500 to-blue-600 hover:from-sky-400 hover:to-blue-500 text-white font-bold w-12 h-12 rounded-lg ml-2 my-auto transition-all transform hover:scale-110 active:scale-100 disabled:bg-slate-500 disabled:cursor-not-allowed disabled:scale-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                        </button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, doc, getDoc, setDoc, query, orderBy, limit, onSnapshot, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- DOM Elements ---
        const loginOverlay = document.getElementById('login-overlay'),
              googleSigninBtn = document.getElementById('google-signin-btn'),
              appContainer = document.getElementById('app-container'),
              userProfile = document.getElementById('user-profile'),
              chatList = document.getElementById('chat-list'),
              chatView = document.getElementById('chat-view'),
              userInput = document.getElementById('userInput'),
              chatForm = document.getElementById('chat-form'),
              submitBtn = document.getElementById('submitBtn'),
              chatMessages = document.getElementById('chat-messages'),
              newChatBtn = document.getElementById('newChatBtn'),
              sidebarToggleBtn = document.getElementById('sidebar-toggle-btn'),
              sidebar = document.getElementById('sidebar'),
              mainContent = document.getElementById('main-content'),
              sidebarOverlay = document.getElementById('sidebar-overlay'),
              confirmationModal = document.getElementById('confirmation-modal'),
              confirmBtn = document.getElementById('confirm-btn'),
              cancelBtn = document.getElementById('cancel-btn'),
              openToolsModalBtn = document.getElementById('open-tools-modal-btn');


        // --- Firebase & State ---
        let db, auth, currentUserData = null, currentChatId = null, unsubscribeMessages = null, unsubscribeChats = null;
        
        const firebaseConfig = {
            apiKey: "AIzaSyDaCWkD_0cuGafWJAiDAFtvPAmst4PX99U",
            authDomain: "ask-twist.firebaseapp.com",
            projectId: "ask-twist",
            storageBucket: "ask-twist.appspot.com",
            messagingSenderId: "342736773610",
            appId: "1:342736773610:web:da6e5a4b77afeb1b5a9293"
        };
        const geminiApiKey = "AIzaSyD28KkSN0-uq-TVJMO67Ur6vpOk7OvC2JM";

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) { 
            console.error("Firebase initialization failed.", e);
        }
        
        // --- Sound Effects ---
        const sendSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.005, decay: 0.1, sustain: 0.3, release: 0.1 } }).toDestination();
        const receiveSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.005, decay: 0.2, sustain: 0.2, release: 0.2 } }).toDestination();

        // --- Auth & UI Setup ---
        onAuthStateChanged(auth, async (user) => {
            if (unsubscribeChats) unsubscribeChats();
            if (unsubscribeMessages) unsubscribeMessages();
            if (user) {
                const userRef = doc(db, "users", user.uid);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists()) {
                    currentUserData = { id: user.uid, ...userSnap.data() };
                    showApp();
                    listenToUserChats();
                } else {
                    // This case is for first-time Google sign-in users
                    // We need to create their profile.
                    const newUserProfile = { displayName: user.displayName, email: user.email, photoURL: user.photoURL, aiNotes: "مستخدم جديد، يبدو فضولياً." };
                    await setDoc(doc(db, "users", user.uid), newUserProfile);
                    currentUserData = { id: user.uid, ...newUserProfile };
                    showApp();
                    listenToUserChats();
                }
            } else {
                showLogin();
            }
        });

        googleSigninBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(err => {
                console.error("Sign-in error", err);
            });
        });

        function showLogin() {
            loginOverlay.classList.remove('hidden');
            appContainer.classList.add('hidden');
        }

        function showApp() {
            loginOverlay.classList.add('hidden');
            appContainer.classList.remove('hidden');
            updateUserProfileUI();
            const savedTheme = localStorage.getItem('twist-theme') || 'default';
            document.body.className = `bg-slate-950 text-slate-200 ${savedTheme}`;
        }
        
        function updateUserProfileUI() {
            if (!currentUserData) return;
            userProfile.innerHTML = `
                <img src="${currentUserData.photoURL}" alt="User Avatar" class="w-10 h-10 rounded-full border-2" style="border-color: var(--accent-color);">
                <span class="font-semibold flex-grow truncate text-white">${currentUserData.displayName}</span>
                <button id="theme-switcher" title="تغيير المظهر" class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg></button>
                <button id="logout-btn" title="تسجيل الخروج" class="action-icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('theme-switcher').addEventListener('click', switchTheme);
        }
        
        const themes = ['default', 'theme-cosmic', 'theme-forest'];
        let currentThemeIndex = 0;
        function switchTheme() {
            currentThemeIndex = (currentThemeIndex + 1) % themes.length;
            const newTheme = themes[currentThemeIndex];
            document.body.className = `bg-slate-950 text-slate-200 ${newTheme}`;
            localStorage.setItem('twist-theme', newTheme);
        }

        // --- Chat Management ---
        function listenToUserChats() {
            if(unsubscribeChats) unsubscribeChats();
            const chatsRef = collection(db, `users/${auth.currentUser.uid}/chats`);
            const q = query(chatsRef, orderBy("createdAt", "desc"));
            unsubscribeChats = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    createNewChat();
                } else {
                    renderChatList(snapshot.docs);
                    if (!currentChatId || !snapshot.docs.some(doc => doc.id === currentChatId)) {
                        switchChat(snapshot.docs[0].id);
                    }
                }
            });
        }

        function renderChatList(chatDocs) {
            chatList.innerHTML = '';
            chatDocs.forEach(doc => {
                const chatData = doc.data();
                const chatItem = document.createElement('div');
                chatItem.className = 'flex items-center gap-2 group';
                const chatButton = document.createElement('button');
                chatButton.dataset.chatId = doc.id;
                const isActive = doc.id === currentChatId;
                chatButton.className = `flex-grow text-right p-2 rounded-lg truncate transition-colors ${isActive ? 'bg-sky-600/50 text-white' : 'text-slate-400 hover:bg-slate-700/50 hover:text-slate-200'}`;
                chatButton.textContent = chatData.title || "محادثة جديدة";
                const deleteButton = document.createElement('button');
                deleteButton.dataset.chatId = doc.id;
                deleteButton.className = 'delete-chat-btn p-1 text-slate-500 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity';
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>`;
                chatItem.appendChild(chatButton);
                chatItem.appendChild(deleteButton);
                chatList.appendChild(chatItem);
            });
        }
        
        chatList.addEventListener('click', (e) => {
            const chatButton = e.target.closest('button:not(.delete-chat-btn)');
            const deleteButton = e.target.closest('.delete-chat-btn');
            if (deleteButton) {
                const chatIdToDelete = deleteButton.dataset.chatId;
                showConfirmationModal('هل أنت متأكد من حذف هذه المحادثة؟', () => {
                    deleteChat(chatIdToDelete);
                });
            } else if (chatButton) {
                const chatId = chatButton.dataset.chatId;
                if (chatId !== currentChatId) switchChat(chatId);
                if (window.innerWidth < 768) {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.add('hidden');
                }
            }
        });

        async function deleteChat(chatIdToDelete) {
            try {
                const messagesRef = collection(db, `users/${auth.currentUser.uid}/chats/${chatIdToDelete}/messages`);
                const messagesSnap = await getDocs(messagesRef);
                const deletePromises = messagesSnap.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                await deleteDoc(doc(db, `users/${auth.currentUser.uid}/chats/${chatIdToDelete}`));
                if (currentChatId === chatIdToDelete) currentChatId = null; 
            } catch (error) {
                console.error("Error deleting chat:", error);
            }
        }

        function switchChat(chatId) {
            currentChatId = chatId;
            listenToMessages(chatId);
            // Visually update active chat without re-fetching
            document.querySelectorAll('#chat-list button').forEach(btn => {
                btn.classList.toggle('bg-sky-600/50', btn.dataset.chatId === chatId);
                btn.classList.toggle('text-white', btn.dataset.chatId === chatId);
                btn.classList.toggle('text-slate-400', btn.dataset.chatId !== chatId);
            });
        }

        async function createNewChat() {
            try {
                const chatsRef = collection(db, `users/${auth.currentUser.uid}/chats`);
                const newChatRef = await addDoc(chatsRef, { createdAt: serverTimestamp(), title: "محادثة جديدة" });
                await saveMessage(`أهلاً يا ${currentUserData.displayName}. أنا تويست، كيف أخدمك اليوم؟`, 'bot', newChatRef.id);
                switchChat(newChatRef.id);
            } catch (error) {
                console.error("Error creating new chat:", error);
            }
        }

        function listenToMessages(chatId) {
            if (unsubscribeMessages) unsubscribeMessages();
            chatMessages.innerHTML = '';
            const messagesRef = collection(db, `users/${auth.currentUser.uid}/chats/${chatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp"));
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const msgData = change.doc.data();
                        addMessageToUI(msgData.text, msgData.sender, change.doc.id);
                    }
                });
            });
        }
        
        function scrollToBottom() { 
            setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 50);
        }

        function addMessageToUI(text, sender, messageId) {
            const messageContainer = document.createElement('div');
            messageContainer.className = 'message-wrapper pop-in w-full';
            const isUser = sender === 'user';
            
            messageContainer.innerHTML = `
                <div class="flex items-start gap-3 ${isUser ? 'justify-end' : ''}">
                    ${!isUser ? `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-sky-500 to-fuchsia-600 flex items-center justify-center font-bold text-lg flex-shrink-0 shadow-lg">T</div>` : ''}
                    <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-xl">
                        <div class="p-3 rounded-xl shadow-md ${isUser ? 'text-white' : 'bg-slate-700/80 glass-pane'} text-right" ${isUser ? `style="background-color: var(--user-bubble-color);"` : ''}>
                            <p class="bot-text-content whitespace-pre-wrap">${isUser ? text : ''}</p>
                        </div>
                    </div>
                    ${isUser ? `<img src="${currentUserData.photoURL}" class="w-10 h-10 rounded-full flex-shrink-0" alt="User Avatar">` : ''}
                </div>`;
            
            chatMessages.appendChild(messageContainer);
            if (!isUser) {
                animateTyping(messageContainer.querySelector('.bot-text-content'), text);
            }
            scrollToBottom();
        }
        
        function animateTyping(element, text) {
            let i = 0;
            element.textContent = "";
            const cursor = document.createElement('span');
            cursor.className = 'blinking-cursor text-[color:var(--accent-color)]';
            cursor.innerHTML = '&#9646;';
            element.appendChild(cursor);
            const typingInterval = setInterval(() => {
                if (i < text.length) {
                    element.insertBefore(document.createTextNode(text.charAt(i)), cursor);
                    i++;
                    scrollToBottom();
                } else {
                    clearInterval(typingInterval);
                    cursor.remove();
                }
            }, 25);
        }

        async function saveMessage(text, sender, chatId = currentChatId) {
            if (!chatId) return;
            try {
                const messagesRef = collection(db, `users/${auth.currentUser.uid}/chats/${chatId}/messages`);
                return await addDoc(messagesRef, { text, sender, timestamp: serverTimestamp() });
            } catch (error) {
                console.error("Error saving message:", error);
            }
        }

        async function getGeminiResponse(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
            const messagesRef = collection(db, `users/${auth.currentUser.uid}/chats/${currentChatId}/messages`);
            const q = query(messagesRef, orderBy("timestamp", "desc"), limit(8));
            const snapshot = await getDocs(q);
            const history = snapshot.docs.reverse().map(doc => ({ role: doc.data().sender === 'user' ? 'user' : 'model', parts: [{ text: doc.data().text }] }));
            
            const systemInstruction = `أنت "تويست"، بوت مصري ذكي ودمه تقيل. مهمتك ترد على المستخدم اللي اسمه "${currentUserData.displayName}" بأسلوب ساخر وفيه قصف جبهات وطحن خواطر. لازم ردودك تكون قصيرة، غير متوقعة، وباللهجة المصرية. لو طلب منك طلب مباشر زي "قول نكتة"، نفذ الطلب بس بأسلوبك الساخر. ملاحظاتك الحالية عن المستخدم: "${currentUserData.aiNotes}"`;
            
            const contents = [ { role: 'user', parts: [{ text: systemInstruction }] }, { role: 'model', parts: [{ text: "تمام، أنا جاهز." }] }, ...history, { role: 'user', parts: [{ text: prompt }] } ];

            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents }) });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const result = await response.json();
                const aiResponse = result.candidates?.[0]?.content?.parts?.[0]?.text.trim() || "عفواً، حدث خطأ ما.";
                updateUserAINotes(prompt, aiResponse);
                return aiResponse;
            } catch (error) {
                console.error("Gemini API error:", error);
                return "يبدو أن عقلي الإلكتروني يعاني من صداع الآن، حاول مرة أخرى.";
            }
        }
        
        async function updateUserAINotes(lastQuestion, lastAnswer) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
            const prompt = `حلل شخصية المستخدم من سؤاله الأخير وإجابتي عليه، وحدّث ملاحظاتك عنه في جملة واحدة بأسلوب ساخر. الملاحظات السابقة: "${currentUserData.aiNotes}" سؤاله الأخير: "${lastQuestion}" إجابتي: "${lastAnswer}" الملاحظات المحدثة (جملة واحدة بس):`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: prompt }] }] }) });
                const result = await response.json();
                const newNotes = result.candidates?.[0]?.content?.parts?.[0]?.text.trim();
                if (newNotes) {
                    await updateDoc(doc(db, "users", auth.currentUser.uid), { aiNotes: newNotes });
                    currentUserData.aiNotes = newNotes;
                }
            } catch(e) { console.error("Could not update AI notes:", e); }
        }

        async function generateChatTitle(firstMessage) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${geminiApiKey}`;
            const prompt = `لخص هذا السؤال في ٣ كلمات أو أقل ليكون عنواناً للمحادثة: "${firstMessage}"`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ role: 'user', parts: [{ text: prompt }] }] }) });
                const result = await response.json();
                const newTitle = result.candidates?.[0]?.content?.parts?.[0]?.text.trim();
                if (newTitle) await updateDoc(doc(db, `users/${auth.currentUser.uid}/chats/${currentChatId}`), { title: newTitle });
            } catch(e) { console.error("Could not generate title:", e); }
        }

        async function handleSubmit(event) {
            event.preventDefault();
            const text = userInput.value.trim();
            if (!text || !currentChatId) return;
            submitBtn.disabled = true;
            userInput.value = '';
            
            const messagesRef = collection(db, `users/${auth.currentUser.uid}/chats/${currentChatId}/messages`);
            const messagesSnap = await getDocs(messagesRef);
            const isFirstUserMessage = messagesSnap.docs.filter(doc => doc.data().sender === 'user').length === 0;

            await saveMessage(text, 'user');
            sendSynth.triggerAttackRelease("C5", "8n");

            if (isFirstUserMessage) await generateChatTitle(text);
            
            document.getElementById('chat-messages').innerHTML += `<div id="loading-indicator" class="flex items-start gap-3 pop-in"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-sky-500 to-fuchsia-600 flex items-center justify-center font-bold text-lg flex-shrink-0 animate-pulse">T</div><div class="bg-slate-700/80 glass-pane p-4 rounded-xl"><div class="flex items-center space-x-2 space-x-reverse"><span class="w-2.5 h-2.5 bg-sky-400 rounded-full animate-pulse" style="animation-delay: 0s;"></span><span class="w-2.5 h-2.5 bg-sky-400 rounded-full animate-pulse" style="animation-delay: 0.2s;"></span><span class="w-2.5 h-2.5 bg-sky-400 rounded-full animate-pulse" style="animation-delay: 0.4s;"></span></div></div></div>`;
            scrollToBottom();

            const responseText = await getGeminiResponse(text);
            document.getElementById('loading-indicator')?.remove();
            
            await saveMessage(responseText, 'bot');
            receiveSynth.triggerAttackRelease("G5", "8n", Tone.now() + 0.1);
            
            submitBtn.disabled = false;
            userInput.focus();
        }
        
        // --- Event Listeners & Initializers ---
        chatForm.addEventListener('submit', handleSubmit);
        newChatBtn.addEventListener('click', () => createNewChat());
        sidebarToggleBtn.addEventListener('click', () => {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('hidden');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('md:mr-72');
            }
        });
        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.add('hidden');
        });
        
        function showConfirmationModal(message, onConfirm) {
            document.getElementById('confirmation-message').textContent = message;
            confirmationModal.classList.remove('hidden');

            const confirmHandler = () => {
                onConfirm();
                confirmationModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            const cancelHandler = () => {
                confirmationModal.classList.add('hidden');
                confirmBtn.removeEventListener('click', confirmHandler);
                cancelBtn.removeEventListener('click', cancelHandler);
            };

            confirmBtn.addEventListener('click', confirmHandler, { once: true });
            cancelBtn.addEventListener('click', cancelHandler, { once: true });
        }
    </script>
</body>
</html>
